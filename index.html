<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="pouchdb.js"></script>
    <script src="pouchdb.indexeddb.js"></script>
    <title>Document</title>
  </head>
  <body>
    <h1>PouchDB activeTasks testing</h1>

    <p>You can run the following functions in your browser's console:</p>
    <ul>
      <li>
        <code>compactDatabase(n)</code>: Create <code>n</code> dummy documents
        in a dummy database and run a compaction task on it.
      </li>
      <li>
        <code>replicate(n1, n2)</code>: Run a replication between two dummy
        databases. First, `n1` docs will be created on the source database and
        replicated to the destination database. Then, another `n2` docs will be
        created. The subsequent replication will make use of a checkpoint and
        replicate only the newer docs to the replication database.
      </li>
    </ul>

    <script>
      let j = 0;

      PouchDB.prototype.activeTasks.add = new Proxy(
        PouchDB.prototype.activeTasks.add,
        {
          apply: (target, thisArg, argumentsList) => {
            const task = argumentsList[0];
            console.log(
              `➕ Added Task "${task.name}" with ${task.total_items} total items`
            );
            return Reflect.apply(
              target,
              PouchDB.prototype.activeTasks,
              argumentsList
            );
          },
        }
      );

      PouchDB.prototype.activeTasks.update = new Proxy(
        PouchDB.prototype.activeTasks.update,
        {
          apply: (target, thisArg, argumentsList) => {
            const task = PouchDB.prototype.activeTasks.get(argumentsList[0]);
            const durationInMilliseconds =
              new Date().getTime() - new Date(task.created_at).getTime();
            console.log(
              `🖌️ Updated Task "${task.name}" (${task.id}) with ${
                argumentsList[1].completed_items
              }/${task.total_items} items after ${
                durationInMilliseconds / 1000
              } seconds`
            );
            return Reflect.apply(
              target,
              PouchDB.prototype.activeTasks,
              argumentsList
            );
          },
        }
      );

      PouchDB.prototype.activeTasks.remove = new Proxy(
        PouchDB.prototype.activeTasks.remove,
        {
          apply: (target, thisArg, argumentsList) => {
            const task = PouchDB.prototype.activeTasks.get(argumentsList[0]);
            const durationInMilliseconds =
              new Date(task.updated_at).getTime() -
              new Date(task.created_at).getTime();
            console.log(
              `✅ Removed/Completed Task "${task.name}" (${task.id}) with ${
                task.completed_items
              }/${task.total_items} items after ${
                durationInMilliseconds / 1000
              } seconds`
            );
            return Reflect.apply(
              target,
              PouchDB.prototype.activeTasks,
              argumentsList
            );
          },
        }
      );

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function runDummyTasks() {
        const id1 = PouchDB.activeTasks.add({
          name: "Task 1",
          total_items: 12,
        });
        const id2 = PouchDB.activeTasks.add({
          name: "Task 2",
          total_items: 432,
        });
        const id3 = PouchDB.activeTasks.add({
          name: "Task 3",
          total_items: 12098,
        });
        await sleep(500);
        PouchDB.activeTasks.update(id1, { completed_items: 1 });
        PouchDB.activeTasks.update(id3, { completed_items: 1441 });
        await sleep(1800);
        PouchDB.activeTasks.update(id1, { completed_items: 2 });
        PouchDB.activeTasks.update(id2, { completed_items: 144 });
        await sleep(2200);
        PouchDB.activeTasks.update(id3, { completed_items: 8441 });
        PouchDB.activeTasks.update(id2, { completed_items: 223 });
        await sleep(1900);
        PouchDB.activeTasks.update(id1, { completed_items: 10 });
        await sleep(500);
        PouchDB.activeTasks.update(id1, { completed_items: 12 });
        PouchDB.activeTasks.remove(id1);
        PouchDB.activeTasks.update(id2, { completed_items: 423 });
        await sleep(1100);
        PouchDB.activeTasks.update(id3, { completed_items: 12001 });
        await sleep(1050);
        PouchDB.activeTasks.update(id2, { completed_items: 432 });
        PouchDB.activeTasks.remove(id2);
        await sleep(2100);
        PouchDB.activeTasks.update(id3, { completed_items: 12098 });
        PouchDB.activeTasks.remove(id3);
      }

      async function createDummyDocs(db, n = 100) {
        for (let i = 0; i < n; i++, j++) {
          await db.put({
            _id: `dummy-${j}`,
            title: `Dummy item ${j}`,
          });
        }
      }

      async function replicate(n1 = 1000, n2 = 100) {
        const src = new PouchDB("replication-test-src", {
          adapter: "indexeddb",
        });
        const dst = new PouchDB("replication-test-dst", {
          adapter: "indexeddb",
        });

        console.log(`~~~ creating ${n1} dummy docs`);
        await createDummyDocs(src, n1);

        console.log("~~~ replicating (1)");
        await src.replicate.to(dst);

        console.log(`~~~ creating ${n2} dummy docs`);
        await createDummyDocs(src, n2);

        console.log("~~~ replicating (2)");
        await src.replicate.to(dst);

        await src.destroy();
        await dst.destroy();
      }

      async function compactDatabase(n = 1000) {
        const db = new PouchDB("database-compaction-test", {
          adapter: "indexeddb",
        });
        await createDummyDocs(db, n);
        db._compact({}, () => {
          db.destroy();
        });
      }
    </script>
  </body>
</html>
